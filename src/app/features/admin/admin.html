<div class="admin-container">
  <header class="admin-header">
    <h1>Panneau <span class="gold-text">Administration</span></h1>
    <p>Gérez le contenu de l'application</p>
  </header>

  <div class="tabs-nav">
    <button
      class="tab-btn"
      [class.active]="currentTab() === 'challenges'"
      (click)="setTab('challenges')"
    >
      <i class="fa-solid fa-hand-holding-heart"></i> Défis
    </button>

    <button class="tab-btn" [class.active]="currentTab() === 'users'" (click)="setTab('users')">
      <i class="fa-solid fa-users"></i> Utilisateurs
    </button>
  </div>

  @if (currentTab() === 'challenges') {
    <div class="tab-content fade-in">
      @if (_missionIsLoading()) {
        <app-spinner />
      } @else {
        <div class="action-bar">
          <h3>Gestion des Défis</h3>
          <button class="btn-add" (click)="addItem('challenge')">+ Nouveau Défi</button>
        </div>

        <div class="glass-table-wrapper">
          <table class="glass-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Titre du défi</th>
                <th>Statut</th>
                <th class="text-end">Actions</th>
              </tr>
            </thead>
            <tbody>
              @for (challenge of challenges(); track challenge.id) {
                <tr>
                  <td>#{{ challenge.id }}</td>
                  <td>{{ challenge.name }}</td>
                  <td>
                    <span class="badge">
                      {{ challenge.level }}
                    </span>
                  </td>
                  <td class="text-end">
                    <button class="btn-icon edit" (click)="updateItem('challenge', challenge.id)">
                      <i class="fa-solid fa-pen"></i>
                    </button>
                    <button class="btn-icon delete" (click)="deleteItem('challenge', challenge.id)">
                      <i class="fa-solid fa-trash"></i>
                    </button>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      }
    </div>
  }

  @if (currentTab() === 'users') {
    <div class="tab-content fade-in">
      @if (_userIsLoading()) {
        <app-spinner />
      } @else {
        <div class="action-bar">
          <h3>Utilisateurs</h3>
          <button class="btn-add" (click)="addItem('user')">+ Créer Compte</button>
        </div>

        <div class="glass-table-wrapper">
          <table class="glass-table">
            <thead>
              <tr>
                <th>Utilisateur</th>
                <th>Email</th>
                <th>Rôle</th>
                <th class="text-end">Actions</th>
              </tr>
            </thead>
            <tbody>
              @for (user of users(); track user.id) {
                <tr>
                  <td>
                    <div class="user-cell">
                      <div class="avatar-mini">{{ user.username.charAt(0).toUpperCase() }}</div>
                      <span>{{ user.username }}</span>
                    </div>
                  </td>
                  <td>{{ user.email }}</td>
                  <td>
                    <span class="role-badge" [class.admin]="user.role === 'Admin'">
                      {{ user.role }}
                    </span>
                  </td>
                  <td class="text-end">
                    <button class="btn-icon edit" (click)="updateItem('user', user.id)">
                      <i class="fa-solid fa-pen"></i>
                    </button>
                    <button class="btn-icon delete" (click)="deleteItem('user', user.id)">
                      <i class="fa-solid fa-trash"></i>
                    </button>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      }
    </div>
  }

  @if (isModalOpen()) {
    <div class="modal-backdrop" (click)="closeModal()">
      <div class="modal-glass" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>
            @if (modalType() === 'challenge') {
              Nouveau Défi
            } @else {
              Gestion Utilisateur
            }
          </h3>
          <button class="btn-close" (click)="closeModal()">
            <i class="fa-solid fa-times"></i>
          </button>
        </div>

        @if (modalType() === 'challenge') {
          <form (ngSubmit)="saveChallenge()">
            <div class="form-group">
              <label>Titre du défi</label>
              <input
                type="text"
                [(ngModel)]="newMission.name"
                name="title"
                placeholder="Ex: Lire Sourate Al-Mulk"
                required
                class="glass-input"
              />
            </div>

            <div class="form-group">
              <label>Difficulté</label>
              <select [(ngModel)]="newMission.level" name="level" class="glass-input">
                <option value="Facile">Facile</option>
                <option value="Moyen">Moyen</option>
                <option value="Difficile">Difficile</option>
              </select>
            </div>

            <div class="modal-actions">
              <button type="button" class="btn-cancel" (click)="closeModal()">Annuler</button>

              <button type="submit" class="btn-save" [disabled]="isSubmitting()">
                @if (isSubmitting()) {
                  <i class="fa-solid fa-spinner fa-spin"></i> ...
                } @else {
                  Sauvegarder
                }
              </button>
            </div>
          </form>
        }

        @if (modalType() === 'user') {
          <form (ngSubmit)="saveUser()">
            <div class="form-group">
              <label>Nom d'utilisateur</label>
              <input
                type="text"
                [(ngModel)]="newUser.username"
                name="username"
                placeholder="Ex: Amine"
                required
                class="glass-input"
              />
            </div>

            <div class="form-group">
              <label>Email</label>
              <input
                type="email"
                [(ngModel)]="newUser.email"
                name="email"
                placeholder="Ex: mail@test.com"
                required
                class="glass-input"
              />
            </div>

            <div class="form-group">
              <label>Rôle</label>
              <select [(ngModel)]="newUser.role" name="role" class="glass-input">
                <option value="User">Utilisateur</option>
                <option value="Admin">Administrateur</option>
              </select>
            </div>

            <div class="modal-actions">
              <button type="button" class="btn-cancel" (click)="closeModal()">Annuler</button>

              <button type="submit" class="btn-save" [disabled]="isSubmitting()">
                @if (isSubmitting()) {
                  <i class="fa-solid fa-spinner fa-spin"></i> ...
                } @else {
                  Sauvegarder
                }
              </button>
            </div>
          </form>
        }
      </div>
    </div>
  }
</div>
